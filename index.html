<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Prize Scanner & Inventory</title>
    
    <!-- PWA Manifest and Theme Color -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A5568"/>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* Prevents pull-to-refresh and other annoying mobile browser behaviors */
        body {
            overscroll-behavior-y: contain;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        /* More robust scanner view styling */
        .reader-container {
            position: relative;
            background: black;
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 0.5rem; 
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .reader-element {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
        }
        /* Target the video element injected by the library */
        .reader-element video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }
        .scanner-line {
            position: absolute;
            left: 5%;
            right: 5%;
            height: 2px;
            background: red;
            box-shadow: 0 0 10px red;
            animation: scan 2s infinite linear;
        }
        @keyframes scan {
            0% { top: 10%; }
            50% { top: 90%; }
            100% { top: 10%; }
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.75);
        }
        main {
            padding-bottom: 80px;
            overflow-y: auto;
        }
        main::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- App Container -->
    <div id="app" class="max-w-md mx-auto h-screen flex flex-col">

        <!-- =================================================================== -->
        <!-- =================== SCANNER INTERFACE =========================== -->
        <!-- =================================================================== -->
        <div id="scannerView" class="h-full flex-grow flex-col hidden">
            <!-- Header -->
            <header class="p-3 bg-white shadow-md z-20">
                <h1 class="text-xl font-bold text-center">Prize Scanner</h1>
                <button id="connectButton" class="w-full mt-2 py-2 px-4 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400">
                    Connect to Scanner
                </button>
                <div id="bleStatus" class="text-center text-sm text-gray-500 mt-1">Status: Disconnected</div>
            </header>

            <!-- Main Content -->
            <main class="flex-grow p-4">
                <div id="reader-container" class="reader-container">
                    <div id="reader" class="reader-element"></div>
                    <div class="scanner-line"></div>
                </div>
                <div id="scanResult" class="mt-4 p-3 bg-white rounded-lg text-center font-mono break-words">
                    Hold Scan Button to Scan
                </div>
            </main>
            
            <!-- Bottom Navigation Bar -->
            <footer class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-gray-800 text-white p-2 flex justify-around items-center shadow-lg z-20">
                <button id="scanButton" class="flex flex-col items-center justify-center p-2 rounded-lg hover:bg-gray-700 disabled:opacity-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span class="text-xs">Scan</span>
                </button>
                <button id="multiplierButton" class="flex flex-col items-center justify-center p-2 rounded-lg hover:bg-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                    <span id="multiplierLabel" class="text-xs">Qty: 1</span>
                </button>
                <button id="redeemButton" class="flex flex-col items-center justify-center p-2 rounded-lg bg-green-500 hover:bg-green-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    <span class="text-xs">Redeem</span>
                </button>
            </footer>
        </div>

        <!-- =================================================================== -->
        <!-- =================== PRODUCT CATALOG SECTION ===================== -->
        <!-- =================================================================== -->
        <div id="databaseLoginView" class="h-full p-8 flex flex-col items-center justify-center bg-gray-200">
            <div class="text-center">
                <h2 class="text-2xl font-bold mb-4">Product Database</h2>
                <p class="mb-6 text-gray-600">Scan your database encryption key to load the product catalog.</p>
                <button id="scanDbKeyButton" class="w-full py-3 px-4 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600">
                    Scan Database Key
                </button>
                <div id="dbStatus" class="mt-4 text-sm text-red-500 font-semibold"></div>
            </div>
        </div>

        <div id="productCatalogView" class="hidden h-full flex-grow flex-col">
            <!-- Header for Catalog -->
            <header class="p-3 bg-white shadow-md z-10 flex-shrink-0">
                <div class="flex gap-2">
                    <input type="text" id="searchInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Search by name, barcode...">
                    <button id="addProductButton" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    </button>
                </div>
                <div id="categoryFilters" class="mt-2 flex flex-wrap gap-2"></div>
            </header>

            <!-- Product List -->
            <main id="productList" class="flex-grow p-4 space-y-3 overflow-y-auto"></main>
        </div>

        <!-- Shared Session Indicator Bar -->
        <div id="sessionIndicator" class="fixed top-0 left-0 right-0 bg-yellow-400 text-black p-1 text-center text-sm font-bold flex justify-between items-center z-30 max-w-md mx-auto hidden">
            <button id="closeSessionButton" class="bg-red-500 text-white text-xs font-bold py-1 px-2 rounded">CLOSE</button>
            <span>Session: <span id="currentSessionName">None</span></span>
            <button id="changeSessionButton" class="bg-blue-500 text-white text-xs font-bold py-1 px-2 rounded">Change</button>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- ========================= MODALS ================================== -->
    <!-- =================================================================== -->
    <div id="sessionModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-40 hidden">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-11/12">
            <h2 class="text-2xl font-bold mb-4 text-center">Select an Action</h2>
            <div class="grid grid-cols-2 gap-4">
                <button class="session-btn py-4 px-2 bg-indigo-500 text-white font-bold rounded-lg shadow-md" data-session="OPEN SESSION01">Session 1</button>
                <button class="session-btn py-4 px-2 bg-indigo-500 text-white font-bold rounded-lg shadow-md" data-session="OPEN SESSION02">Session 2</button>
                <button class="session-btn py-4 px-2 bg-indigo-500 text-white font-bold rounded-lg shadow-md" data-session="OPEN SESSION03">Session 3</button>
                <button class="session-btn py-4 px-2 bg-indigo-500 text-white font-bold rounded-lg shadow-md" data-session="OPEN SESSION04">Session 4</button>
            </div>
            <button id="showCatalogButton" class="w-full mt-4 py-3 bg-gray-600 text-white font-bold rounded-lg shadow-md">View Product Catalog</button>
        </div>
    </div>

    <!-- NEW: Modal specifically for scanning the database key -->
    <div id="dbScannerModal" class="fixed inset-0 bg-black z-50 flex-col items-center justify-center hidden">
        <div id="db-reader-container" class="w-11/12 max-w-md reader-container">
             <div id="db-reader" class="reader-element"></div>
        </div>
        <p class="text-white text-lg mt-4 font-semibold">Scan Database Encryption Key</p>
        <button id="cancelDbScanButton" class="mt-4 py-2 px-6 bg-red-500 text-white font-bold rounded-lg">Cancel</button>
    </div>

    <div id="multiplierModal" class="fixed inset-0 modal-backdrop items-center justify-center z-40 hidden">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-11/12">
            <h2 class="text-2xl font-bold mb-4">Set Quantity</h2>
            <input type="number" id="multiplierInput" class="w-full text-4xl text-center p-2 border-2 rounded-lg mb-4" value="1" min="1" max="99">
            <div class="flex gap-4">
                <button id="cancelMultiplier" class="w-full py-2 bg-gray-500 text-white font-bold rounded-lg">Cancel</button>
                <button id="confirmMultiplier" class="w-full py-2 bg-green-500 text-white font-bold rounded-lg">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="productModal" class="fixed inset-0 modal-backdrop items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-11/12 max-w-lg max-h-screen overflow-y-auto">
            <h2 id="productModalTitle" class="text-2xl font-bold mb-4">Add New Product</h2>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="mb-4">
                    <label for="productName" class="block text-sm font-medium text-gray-700">Product Name</label>
                    <input type="text" id="productName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="mb-4">
                    <label for="productBarcode" class="block text-sm font-medium text-gray-700">Barcode / SKU</label>
                    <input type="text" id="productBarcode" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label for="productStock" class="block text-sm font-medium text-gray-700">Stock Count</label>
                    <input type="number" id="productStock" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" value="0" min="0">
                </div>
                <div class="mb-4">
                    <label for="productCategory" class="block text-sm font-medium text-gray-700">Category</label>
                    <input type="text" id="productCategory" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="e.g., Electronics, Toys">
                </div>
                <div class="mb-4">
                    <label for="productImage" class="block text-sm font-medium text-gray-700">Product Image</label>
                    <input type="file" id="productImage" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <img id="imagePreview" src="" class="mt-2 h-32 w-32 object-cover rounded-md hidden">
                    <input type="hidden" id="imageBase64">
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="button" id="cancelProductForm" class="w-full py-2 bg-gray-500 text-white font-bold rounded-lg">Cancel</button>
                    <button type="submit" class="w-full py-2 bg-green-500 text-white font-bold rounded-lg">Save Product</button>
                </div>
                 <button type="button" id="deleteProductButton" class="w-full mt-4 py-2 bg-red-600 text-white font-bold rounded-lg hidden">Delete Product</button>
            </form>
        </div>
    </div>


    <script>
        // --- GLOBAL STATE ---
        let currentSession = null;
        let currentMultiplier = 1;
        let prizeScanner = null;
        let dbScanner = null;
        let isScannerRunning = false;
        let commandCharacteristic = null;
        let audioContext;
        let isScanCooldown = false;
        let dbConfig = null;
        let allProducts = [];
        let allCategories = [];
        let activeCategory = 'All';

        // --- CONSTANTS ---
        const SERVICE_UUID = "0000180a-0000-1000-8000-00805f9b34fb";
        const COMMAND_CHARACTERISTIC_UUID = "00002a57-0000-1000-8000-00805f9b34fb";
        const STATUS_CHARACTERISTIC_UUID = "00002a58-0000-1000-8000-00805f9b34fb";
        
        // --- DOM REFERENCES ---
        const scannerView = document.getElementById('scannerView');
        const connectButton = document.getElementById('connectButton');
        const bleStatus = document.getElementById('bleStatus');
        const sessionModal = document.getElementById('sessionModal');
        const multiplierModal = document.getElementById('multiplierModal');
        const currentSessionName = document.getElementById('currentSessionName');
        const scanResult = document.getElementById('scanResult');
        const multiplierLabel = document.getElementById('multiplierLabel');
        const scanButton = document.getElementById('scanButton');
        const sessionIndicator = document.getElementById('sessionIndicator');
        const databaseLoginView = document.getElementById('databaseLoginView');
        const productCatalogView = document.getElementById('productCatalogView');
        const dbStatus = document.getElementById('dbStatus');
        const productList = document.getElementById('productList');
        const categoryFilters = document.getElementById('categoryFilters');
        const searchInput = document.getElementById('searchInput');
        const showCatalogButton = document.getElementById('showCatalogButton');
        const productModal = document.getElementById('productModal');
        const productForm = document.getElementById('productForm');
        const cancelProductForm = document.getElementById('cancelProductForm');
        const addProductButton = document.getElementById('addProductButton');
        const deleteProductButton = document.getElementById('deleteProductButton');
        const imagePreview = document.getElementById('imagePreview');
        const productImageInput = document.getElementById('productImage');
        const imageBase64Input = document.getElementById('imageBase64');
        const dbScannerModal = document.getElementById('dbScannerModal');
        const cancelDbScanButton = document.getElementById('cancelDbScanButton');
        const scanDbKeyButton = document.getElementById('scanDbKeyButton');


        // --- FEEDBACK & UTILITY FUNCTIONS ---
        function playBeep() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        function vibrate() {
            if ('vibrate' in navigator) {
                navigator.vibrate(200);
            }
        }
        
        function showView(view) {
            scannerView.style.display = 'none';
            databaseLoginView.style.display = 'none';
            productCatalogView.style.display = 'none';
            sessionIndicator.style.display = 'none';

            if (view === 'scanner') {
                scannerView.style.display = 'flex';
                sessionIndicator.style.display = 'flex';
            } else if (view === 'login') {
                databaseLoginView.style.display = 'flex';
            } else if (view === 'catalog') {
                productCatalogView.style.display = 'flex';
            }
        }

        // --- BLE LOGIC ---
        async function sendBleCommand(command) {
            if (!commandCharacteristic) {
                bleStatus.textContent = 'Scanner is disconnected.';
                return false;
            }
            try {
                const encoder = new TextEncoder();
                await commandCharacteristic.writeValue(encoder.encode(command));
                console.log(`Sent: ${command}`);
                return true;
            } catch (error) {
                console.error(`Send Error for command "${command}":`, error);
                bleStatus.textContent = `Send Error: ${error.message}`;
                return false;
            }
        }

        async function sendSequence(commands) {
            bleStatus.textContent = `Processing ${commands.length} commands...`;
            for (const command of commands) {
                const success = await sendBleCommand(command);
                if (!success) {
                    bleStatus.textContent = `Failed on command: ${command}`;
                    return;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            bleStatus.textContent = 'Sequence sent successfully!';
        }

        connectButton.addEventListener('click', async () => {
            if (!navigator.bluetooth) {
                alert('Web Bluetooth API is not available.');
                return;
            }
            try {
                bleStatus.textContent = "Requesting device...";
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }],
                    optionalServices: [SERVICE_UUID]
                });
                device.addEventListener('gattserverdisconnected', onDisconnected);
                bleStatus.textContent = "Connecting...";
                const server = await device.gatt.connect();
                bleStatus.textContent = "Getting Service...";
                const service = await server.getPrimaryService(SERVICE_UUID);
                bleStatus.textContent = "Getting Characteristics...";
                commandCharacteristic = await service.getCharacteristic(COMMAND_CHARACTERISTIC_UUID);
                const statusCharacteristic = await service.getCharacteristic(STATUS_CHARACTERISTIC_UUID);
                await statusCharacteristic.startNotifications();
                statusCharacteristic.addEventListener('characteristicvaluechanged', handleStatusUpdate);
                connectButton.disabled = true;
                connectButton.textContent = 'Connected';
                bleStatus.textContent = '✅ Ready to Scan';
            } catch (error) {
                bleStatus.textContent = `Connection Failed: ${error.message}`;
                console.error(error);
            }
        });

        function onDisconnected() {
            bleStatus.textContent = 'Disconnected. Please reconnect.';
            connectButton.disabled = false;
            connectButton.textContent = 'Connect to Scanner';
            commandCharacteristic = null;
            if (isScannerRunning) {
                stopPrizeScanner();
            }
        }

        function handleStatusUpdate(event) {
            const statusMessage = new TextDecoder().decode(event.target.value);
            bleStatus.textContent = `ESP32: ${statusMessage}`;
        }

        // --- SESSION MANAGEMENT ---
        function setSession(sessionCommand) {
            currentSession = sessionCommand;
            const sessionNumber = sessionCommand.slice(-2);
            currentSessionName.textContent = `S${sessionNumber}`;
            sessionModal.style.display = 'none';
            sendSequence([currentSession]);
            showView('scanner');
        }
        document.querySelectorAll('.session-btn').forEach(button => button.addEventListener('click', () => setSession(button.dataset.session)));
        document.getElementById('changeSessionButton').addEventListener('click', () => sessionModal.style.display = 'flex');
        
        document.getElementById('closeSessionButton').addEventListener('click', () => {
            if (!currentSession) {
                alert('No session is active.');
                return;
            }
            sendSequence(['CLOSE SESSION']);
        });

        // --- PRIZE SCANNER LOGIC ---
        const onPrizeScanSuccess = (decodedText) => {
            if (isScanCooldown) return;
            isScanCooldown = true;
            
            playBeep();
            vibrate();

            scanResult.textContent = `Scanned: ${decodedText}`;
            
            let commands = [currentSession]; 
            if (currentMultiplier > 1) {
                commands.push(currentMultiplier.toString());
            }
            commands.push(decodedText);
            
            sendSequence(commands);
            
            currentMultiplier = 1;
            multiplierLabel.textContent = "Qty: 1";

            setTimeout(() => {
                isScanCooldown = false;
                if (isScannerRunning) {
                    scanResult.textContent = "Scanning...";
                }
            }, 2000);
        };
        
        function startPrizeScanner() {
            if (isScannerRunning || !prizeScanner) return;
            if (!currentSession) {
                alert("Please select a session first.");
                sessionModal.style.display = 'flex';
                return;
            }
            isScannerRunning = true;
            scanButton.classList.add('text-green-400');
            scanResult.textContent = "Scanning...";
            prizeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onPrizeScanSuccess, (e) => {})
            .catch(err => {
                isScannerRunning = false;
                scanButton.classList.remove('text-green-400');
                scanResult.textContent = "Error starting camera.";
            });
        }
        
        function stopPrizeScanner() {
            if (!isScannerRunning || !prizeScanner || prizeScanner.getState() !== 2) return;
            prizeScanner.stop().finally(() => {
                isScannerRunning = false;
                scanButton.classList.remove('text-green-400');
                scanResult.textContent = "Hold Scan Button to Scan";
            });
        }
        
        scanButton.addEventListener('mousedown', startPrizeScanner);
        scanButton.addEventListener('mouseup', stopPrizeScanner);
        scanButton.addEventListener('mouseleave', stopPrizeScanner);
        scanButton.addEventListener('touchstart', (e) => { e.preventDefault(); startPrizeScanner(); });
        scanButton.addEventListener('touchend', stopPrizeScanner);

        // --- OTHER UI ACTIONS (Prize Scanner) ---
        document.getElementById('redeemButton').addEventListener('click', () => {
             if (!currentSession) {
                alert('Please select a session before redeeming.');
                return;
            }
            sendSequence([currentSession, 'REDEMPTION']);
        });

        document.getElementById('multiplierButton').addEventListener('click', () => multiplierModal.style.display = 'flex');
        document.getElementById('cancelMultiplier').addEventListener('click', () => multiplierModal.style.display = 'none');
        document.getElementById('confirmMultiplier').addEventListener('click', () => {
            const value = parseInt(document.getElementById('multiplierInput').value, 10);
            currentMultiplier = Math.max(1, value);
            multiplierLabel.textContent = `Qty: ${currentMultiplier}`;
            multiplierModal.style.display = 'none';
        });

        // --- DATABASE AUTH & LOADING LOGIC ---
        async function fetchFromDB(endpoint, options = {}) {
            if (!dbConfig) {
                console.error("Database is not configured.");
                return null;
            }
            const url = new URL(dbConfig.url);
            url.searchParams.append('token', dbConfig.token);
            if (options.method !== 'POST') {
                url.searchParams.append('endpoint', endpoint);
            }

            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                dbStatus.textContent = `Error: ${error.message}.`;
                return null;
            }
        }

        async function loadDatabase() {
            dbStatus.textContent = 'Loading products...';
            const data = await fetchFromDB('getProducts');
            
            if (data && data.success && data.products) {
                allProducts = data.products;
                const categories = new Set(allProducts.map(p => p.Category).filter(Boolean));
                allCategories = ['All', ...categories];
                
                renderProducts();
                renderCategories();
                
                sessionModal.style.display = 'flex'; // Show action choice
                dbStatus.textContent = '';
            } else {
                dbStatus.textContent = `Failed to load products: ${data ? data.message : 'Network error'}`;
                localStorage.removeItem('dbConfig');
                dbConfig = null;
                showView('login');
            }
        }
        
        function onDbKeyScanSuccess(decodedText) {
            dbScanner.stop().then(() => {
                dbScannerModal.style.display = 'none';
                try {
                    const url = new URL(decodedText);
                    const token = url.searchParams.get('token');
                    if (!token) {
                        dbStatus.textContent = 'Invalid Key: No token found.';
                        return;
                    }
                    dbConfig = { url: `${url.protocol}//${url.host}${url.pathname}`, token: token };
                    localStorage.setItem('dbConfig', JSON.stringify(dbConfig));
                    loadDatabase();
                } catch (error) {
                    dbStatus.textContent = 'Invalid QR Code. Must be a valid URL.';
                }
            });
        }

        scanDbKeyButton.addEventListener('click', () => {
            dbScannerModal.style.display = 'flex';
            dbScanner.start({ facingMode: "environment" }, { fps: 5, qrbox: { width: 250, height: 250 } }, onDbKeyScanSuccess, (e) => {})
            .catch(err => {
                alert("Could not start camera. Please grant permission.");
                dbScannerModal.style.display = 'none';
            });
        });

        cancelDbScanButton.addEventListener('click', () => {
            if (dbScanner && dbScanner.getState() === 2) {
                dbScanner.stop();
            }
            dbScannerModal.style.display = 'none';
        });

        // --- CATALOG RENDERING & UI ---
        function renderProducts() {
            productList.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            
            const filteredProducts = allProducts.filter(product => {
                const inCategory = activeCategory === 'All' || product.Category === activeCategory;
                const matchesSearch = product.ProductName.toLowerCase().includes(searchTerm) || 
                                      (product.Barcode && product.Barcode.toLowerCase().includes(searchTerm));
                return inCategory && matchesSearch;
            });

            if (filteredProducts.length === 0) {
                productList.innerHTML = `<p class="text-gray-500 text-center">No products found.</p>`;
            } else {
                filteredProducts.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-3 rounded-lg shadow flex items-center gap-4 cursor-pointer hover:bg-gray-50';
                    card.innerHTML = `
                        <img src="${product.ImageBase64 || 'https://via.placeholder.com/80'}" class="w-20 h-20 object-cover rounded-md bg-gray-200">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg">${product.ProductName}</h3>
                            <p class="text-sm text-gray-600">${product.Barcode || 'No Barcode'}</p>
                            <p class="text-sm text-gray-500">Category: ${product.Category || 'None'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-bold">${product.StockCount}</p>
                            <p class="text-xs text-gray-500">In Stock</p>
                        </div>
                    `;
                    card.addEventListener('click', () => openProductModal(product));
                    productList.appendChild(card);
                });
            }
        }

        function renderCategories() {
            categoryFilters.innerHTML = '';
            allCategories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = 'px-3 py-1 text-sm font-medium rounded-full';
                button.className += (category === activeCategory) ? ' bg-blue-500 text-white' : ' bg-gray-200 text-gray-700';
                button.addEventListener('click', () => {
                    activeCategory = category;
                    renderCategories();
                    renderProducts();
                });
                categoryFilters.appendChild(button);
            });
        }

        // --- PRODUCT MODAL & FORM LOGIC ---
        function openProductModal(product = null) {
            productForm.reset();
            imagePreview.classList.add('hidden');
            deleteProductButton.classList.add('hidden');
            imageBase64Input.value = '';

            if (product) {
                document.getElementById('productModalTitle').textContent = 'Edit Product';
                document.getElementById('productId').value = product.ProductID;
                document.getElementById('productName').value = product.ProductName;
                document.getElementById('productBarcode').value = product.Barcode;
                document.getElementById('productStock').value = product.StockCount;
                document.getElementById('productCategory').value = product.Category;
                if (product.ImageBase64) {
                    imagePreview.src = product.ImageBase64;
                    imagePreview.classList.remove('hidden');
                    imageBase64Input.value = product.ImageBase64;
                }
                deleteProductButton.classList.remove('hidden');
            } else {
                document.getElementById('productModalTitle').textContent = 'Add New Product';
            }
            productModal.style.display = 'flex';
        }

        function closeProductModal() {
            productModal.style.display = 'none';
        }

        addProductButton.addEventListener('click', () => openProductModal());
        cancelProductForm.addEventListener('click', closeProductModal);
        
        showCatalogButton.addEventListener('click', () => {
             if (dbConfig) {
                sessionModal.style.display = 'none';
                showView('catalog');
             } else {
                alert("Database not loaded. Please scan the database key from the login screen.");
                sessionModal.style.display = 'none';
                showView('login');
             }
        });

        // ===================================================================
        // ============= NEW, REVISED IMAGE HANDLING FUNCTION ================
        // ===================================================================
        productImageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            
            reader.onload = (e) => {
                const image = new Image();
                image.src = e.target.result;

                image.onload = () => {
                    const canvas = document.createElement('canvas');
                    let { width, height } = image;

                    // Calculate the new dimensions
                    if (width > height) {
                        if (width > MAX_IMAGE_DIMENSION) {
                            height *= MAX_IMAGE_DIMENSION / width;
                            width = MAX_IMAGE_DIMENSION;
                        }
                    } else {
                        if (height > MAX_IMAGE_DIMENSION) {
                            width *= MAX_IMAGE_DIMENSION / height;
                            height = MAX_IMAGE_DIMENSION;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(image, 0, 0, width, height);
                    
                    // Get the resized image as a JPEG Base64 string (more compact than PNG)
                    const resizedBase64 = canvas.toDataURL('image/jpeg', 0.8); // 0.8 is the quality level

                    // Update the form
                    imagePreview.src = resizedBase64;
                    imagePreview.classList.remove('hidden');
                    imageBase64Input.value = resizedBase64;
                };
            };

            reader.readAsDataURL(file);
        });

        productForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const productData = {
                ProductID: document.getElementById('productId').value,
                ProductName: document.getElementById('productName').value,
                Barcode: document.getElementById('productBarcode').value,
                StockCount: document.getElementById('productStock').value,
                Category: document.getElementById('productCategory').value,
                ImageBase64: imageBase64Input.value,
            };

            const endpoint = productData.ProductID ? 'updateProduct' : 'addProduct';
            const response = await fetchFromDB(null, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ endpoint: endpoint, data: productData })
            });

            if (response && response.success) {
                closeProductModal();
                await loadDatabase();
            } else {
                alert(`Error: ${response ? response.message : 'Could not save product.'}`);
            }
        });

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            prizeScanner = new Html5Qrcode("reader");
            dbScanner = new Html5Qrcode("db-reader");

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js').catch(err => console.error(err));
            }
            
            const savedDbConfig = localStorage.getItem('dbConfig');
            if (savedDbConfig) {
                dbConfig = JSON.parse(savedDbConfig);
                loadDatabase();
            } else {
                showView('login');
            }
            searchInput.addEventListener('input', renderProducts);
        });
    </script>
</body>
</html>
